{% extends 'main.html' %}

{% block content %}



<div class="home-container">
    
    <div>

        <h3 style="text-align: center;">Danh mục khác</h3>
        <hr>

    </div>

    <div >
        
        <div class="card" >

            <div>
                <!-- <div class="form1">
                    <form action="{% url 'search_user' %}" method="get">
                    <input type="text" name="query" placeholder="Tìm kiếm" id="searchInput" oninput="validateInput1()">
                    <input class="btnn" type="submit" value="Search" id="searchBtn" disabled>
                    </form>
                </div>

                <div>
                    {% for search_user in search_users %}
                    <a href="{% url 'post_profile' search_user.id %}"><span>{{ search_user.username }}</span></a>
                    {% endfor %}
                </div> -->
                <form class="form1">
                    <input  type="text" name="query" placeholder="Tìm kiếm" id="searchInput" oninput="searchUser()"> 
                </form>
                <div id="searchResults">
                    <a data-url="{% url 'post_profile' request.user.id %}"></a>
                </div>
            </div>

            <hr>

            <div>
                <div class="txt">
                    <a href="{% url 'post_profile' request.user.id %}">
                        <img class="img123" src="{{ request.user.profileuser.avatar.url }}">
                    </a>
                    <button class="create-button" onclick="toggleCreatePostForm1(event)">{{request.user.username}} ơi, bạn đang nghĩ gì thế? </button>
                </div>
                
            </div>
            
            <hr>
        
            <div class="widget-post" aria-labelledby="post-header-title" id="create-post-form" style="display: none;">
                <form action="{% url 'create_post' %}" method="post" enctype="multipart/form-data" class="widget-post__form" aria-label="post widget">
                    {% csrf_token %}
                    <div class="widget-post__content">
                        <label for="post-content" class="sr-only">Share</label>
                        <textarea name="discription" class="widget-post__textarea scroller" placeholder="{{request.user.username}} ơi bạn đang nghĩ gì thế? " id="createbox_post" oninput="validateInput2()"></textarea>
                    </div>
                    <div class="widget-post__actions post--actions">
                        <div class="post-actions__attachments">
                            <button type="button" class="btn post-actions__upload attachments--btn">
                            {% csrf_token %}
                            <label for="upload-image" class="post-actions__label">
                                <i class="fa fa-upload" aria-hidden="true"></i> 
                                upload image
                            </label>
                            </button>
                            <input type="file" name="post_image" id="upload-image" multiple>
                        </div>
                        <div class="post-actions__widget">
                            {% csrf_token %}
                            <button type="submit" class="btnn1" id="createbox_btn_post" disabled >publish</button>
                        </div>
                    </div>             
                </form>
            </div>
            
        </div>
        {% for post in posts%}
        
            <div class="card">
                
                <div>
                    <div class="txt">
                        <a href="{% url 'post_profile' post.post_user_id %}">
                            <img class="img123" src="{{ post.get_post_user_avatar.url }}">  
                        <div class="datesince">
                            <a href="{% url 'post_profile' post.post_user_id %}">{{ post.post_user }}</a>
                            <li>{{post.created|timesince}} ago at {{ post.formatted_created_time}}</li>
                        </div>
                    </div>
                    <h5 class="formatted-text">{{ post.discription }}</h5>
                    <img src =" {{ post.post_image.url}}" width="600">
                </div>
                
                <div>
                    <div class="info-container" data-comment="{{ post.commentviews_set.count }}">
                        {% if request.user in post.post_likes.all %} 
                            {% if post.post_likes.count > 1 %}
                                <p id="like-count-{{ post.id }}">Bạn và {{ post.post_likes.count }} người khác thích bài viết này</p>
                                {% if post.commentviews_set.count >= 1 %}
                                    <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}}</p> 
                                {% else %} 
                                    <p>.</p>
                                {% endif %}    
                            {% else %} 
                                <p id="like-count-{{ post.id }}" >Bạn thích bài viết này</p>
                                {% if post.commentviews_set.count >= 1 %}
                                    <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}}</p> 
                                {% else %} 
                                    <p>.</p>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            {% if post.post_likes.count > 0 %}
                                <p id="like-count-{{ post.id }}">{{ post.post_likes.count }} like{{ post.post_likes.count|pluralize }}</p> 
                                {% if post.commentviews_set.count >= 1 %}
                                    <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}}</p> 
                                {% else %} 
                                    <p>.</p>
                                {% endif %}
                            {% else %}
                                <p id="like-count-{{ post.id }}"></p>
                                {% if post.commentviews_set.count >= 1 %}
                                    <p>{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}}</p> 
                                {% else %} 
                                    <p>.</p>
                                {% endif %}
                            {% endif %}   
                        {% endif %}                  
                    </div>
                    <!-- <div id="list_like-{{ post.id }}" >  
                        {% for user in post.post_likes.all %} 
                            <p>{{user.username}}</p>
                        {% endfor %}
                    </div> -->
                </div>
                
                <hr>

                <div class="btn-group">

                    <form action="{% url 'post_likes_homepage' 0 %}" method="post" id="like-form" data-like-id="{{ post.id }}" 
                        data-liked="{% if request.user in post.post_likes.all %} true {% else %} false {% endif %}"> 
                        {% csrf_token %}
                        <button type="submit" id="like-button-{{ post.id }}">
                            {% if request.user in post.post_likes.all %}
                                <a class="my-text">Like</a>
                            {% else %}
                                Like
                            {% endif %}
                        </button>
                    </form>

                    <button onclick="commentAndRefresh('{{ post.id }}')">Comment</button>

                    <button type="submit" id="share-button-{{ post.id }}">Share</button>

                </div>

            </div>   
           
        
            <div class="card-sharepost_popup" id="share-card-{{ post.id }}" style="display:none;"> 
                <form action="{% url 'share_post_views' 0 %}" method="post" id="share-form" data-share-id="{{ post.id }}">
                    {% csrf_token %}
                    <div class="txt">
                        <a href="{% url 'post_profile' request.user.id %}">
                            <img class="img123" src="{{ request.user.profileuser.avatar.url }}">
                        <a href="{% url 'post_profile' request.user.id %}">{{request.user.username}}</a>
                    </div>
                    
                    <textarea name='discription_sh' id="discription_sh" class="share-discription scroller" placeholder="say something about this post "></textarea>
                    
                    <div class="card-sharepost-inner"> 
                        <div class="txt">
                            <a href="{% url 'post_profile' post.post_user_id %}">
                            <img class="img123" src="{{ post.get_post_user_avatar.url }}">  
                            <div class="datesince">
                                <a href="{% url 'post_profile' post.post_user_id %}">{{ post.post_user }}</a>
                                <li>{{post.created|timesince}} ago</li>
                            </div>
                        </div>
                        <h5>{{post.discription}}</h5>                       
                        <h5><img src =" {{ post.post_image.url}}" width="600" ></h5>
                    </div>
                    <br>
                    <button class="btnn" type="submit">Share post </button>
                    <br>
                </form>
            </div>

            <div class="popup" id="comment-popup-{{ post.id }}" style="display: none;">

                <div class="card-shadow">
                    
                    <div>   
                        <!-- <div class="hell">
                            <span>@{{ post.post_user }}</span>
                            <button onclick="closePopupAndReload()">Đóng</button>
                        </div> -->

                        <div class="txt">
                            <a href="{% url 'post_profile' post.post_user_id %}">
                                <img class="img123" src="{{ post.get_post_user_avatar.url }}">  
                            <div class="datesince">
                                <div class="helli">
                                    <a href="{% url 'post_profile' post.post_user_id %}">{{ post.post_user }}</a>
                                    <button onclick="closePopupAndReload()">Đóng</button>
                                </div>
                                <li>{{post.created|timesince}} ago</li>
                            </div>
                        </div>

                        <h5 class="formatted-text">{{ post.discription }}</h5>
                        <h5><img src =" {{ post.post_image.url}}" width="650" ></h5>
                    </div> 
            
                    <div class="info-container" >
                        {% if request.user in post.post_likes.all %} 
                            {% if post.post_likes.count > 1 %}
                                <p id="like-count-section-{{ post.id }}">Bạn và {{ post.post_likes.count }} người khác thích bài viết này</p>
                                {% if post.commentviews_set.count >= 1 %}
                                    <p id="like-count-{{ post.id }}">{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}}</p> 
                                {% else %} 
                                    <p></p>
                                {% endif %} 
                            {% else %} 
                                <p id="like-count-section-{{ post.id }}">Bạn thích bài viết này</p>
                                {% if post.commentviews_set.count >= 1 %}
                                    <p id="like-count-{{ post.id }}">{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}}</p> 
                                {% else %} 
                                    <p></p>
                                {% endif %} 
                            {% endif %}
                        {% else %}
                            {% if post.post_likes.count > 0 %}
                                <p id="like-count-section-{{ post.id }}">{{ post.post_likes.count }} like{{ post.post_likes.count|pluralize }}</p> 
                                {% if post.commentviews_set.count >= 1 %}
                                    <p id="like-count-{{ post.id }}">{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}}</p> 
                                {% else %} 
                                    <p></p>
                                {% endif %}   
                            {% else %}
                                <p id="like-count-section-{{ post.id }}"></p>
                                {% if post.commentviews_set.count >= 1 %}
                                    <p id="like-count-{{ post.id }}">{{ post.commentviews_set.count }} comment{{post.commentviews_set.count|pluralize}}</p> 
                                {% else %} 
                                    <p></p>
                                {% endif %}
                            {% endif %}   
                        {% endif %}   
                    </div>
            
                    <div class="btn-group"> 
                        <form action="{% url 'post_like_post_comment_section' 0 %}" method="post" id="like-popup-form" data-like-id-section="{{ post.id }}"
                        data-liked-section="{% if request.user in post.post_likes.all %} true {% else %} false {% endif %}" >
                            {% csrf_token %}
                            <button type="submit" id="like-button-section-{{ post.id }}">
                                {% if request.user in post.post_likes.all %}
                                <a class="my-text">Like</a>
                                {% else %}
                                    Like
                                {% endif %}
                            </button >
                        </form>
                        <form action="#">
                            {% csrf_token %}  
                            <button type="submit">Comment</button>
                        </form>
                        
                        <form action="#" method="post">
                            {% csrf_token %}  
                            <button type="submit">Share</button>
                        </form>
                    </div>
            
                    <hr>
            
                    <div class="widget-post1" aria-labelledby="post-header-title">
                        <form action="{% url 'send_comment' 0 %}" id="send-comment" data-send-id="{{ post.id }}" method="post" enctype="multipart/form-data" class="widget-post1__form" aria-label="post widget">
                            {% csrf_token %}
                            <div class="widget-post__content">
                                <label for="post-content" class="sr-only">Share</label>
                                <textarea name="message" class="widget-post__textarea1 scroller" placeholder="..." id="message" onkeyup="requesttext()"></textarea>
                            </div>
                            <div class="widget-post__actions1 post--actions1">
                                <div class="post-actions__attachments">
                                    <button type="button" class="btn post-actions__upload attachments--btn">
                                        {% csrf_token %}
                                        <label for="massage_image" class="post-actions__label">
                                        <i class="fa fa-upload" aria-hidden="true"></i> 
                                        image
                                        </label>
                                    </button>
                                    <input type="file" name="massage_image" id="massage_image" multiple>
                                </div>
                                <div class="post-actions__widget">
                                    {% csrf_token %}
                                    <button type="submit" class="btnn1" id="submitButton">Comment</button>
                                </div>                  
                            </div>
                        </form>
                    </div>
            
                    <hr> 
            
                    <div class="comment-cad">
                        {% for comment in post.commentviews_set.all %}
                        <div class="hello">
                            <div class="comment-avatar">
                                <div>
                                    <a href="{% url 'post_profile' comment.comment_user_id %}">
                                    <img class="img12" src="{{ comment.get_comment_user_avatar.url }}">
                                </div>
                                <div class="comment-card1">
                                    <div class="dua_len_ngang_hang_va_dieu_chinh_khoang_cach">
                                        <div id="comment-{{ comment.id }}">
                                            
                                            <div class="txt">
                                                <a href="{% url 'post_profile' comment.comment_user_id %}">{{comment.comment_user }}</a>
                                            </div>
                                            <small class="formatted-text">{{ comment.message }}</small>
                                        </div>
                                        <div class="dropdown">
                                            <span onclick="myFunction('{{ comment.id }}')" class="dropbtn"><i class="fas fa-ellipsis-v"></i></span>
                                            <div id="myDropdown-{{ comment.id }}" class="dropdown-content dropdown-{{ comment.id }}">
                                                {% if comment.comment_user == request.user %}
                                                <a href="{% url 'del_comment' comment.id %}" onclick="deleteComment('{{ comment.id }}')" >del_comment</a>
                                                {% endif %}
                                                <a>Modify</a>
                                                <a>report comment</a>
                                            </div>
                                        </div> 
                                    </div>
                                    <div>
                                        {% if comment.massage_image %}
                                            <h1><img src="{{ comment.massage_image.url }}" width="100"></h1>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="mode-font-rep" onclick="toggleCreatePostForm2(event,'repply-form-{{ comment.id }}')">Phản hồi</button>  
                                <button class="mode-font-like">Like</button> 
                            </div>
                            <div class="message-form">
                                <form action="{% url 'repply_comment' comment.id %}" method="post" id="repply-form-{{ comment.id }}" style="display: none;" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="form-row">
                                        <input type="text" name="rep_message" placeholder="Type your message">
                                        <label for="rep_mess_image" class="upload-icon">
                                            <input type="file" name="rep_mess_image" id="rep_mess_image" multiple>
                                            <i class="fas fa-file-image"></i>
                                        </label>
                                        <button type="submit" class="send-button">
                                        <i class="fas fa-arrow-right"></i>
                                        </button>
                                    </div>
                                </form>
                            </div> 
                            <div>
                                {% if comment.repply_commentviews_set.all %}
                                    {% for rep_comment in comment.repply_commentviews_set.all %}
                                        <div class="comment-cad-repply"> 
                                            <h5><a href=" {% url 'post_profile' rep_comment.user_rep_id %}">@{{ rep_comment.user_rep.username }}</a></h5>
                                            <a class="formatted-text">{{ rep_comment.rep_message }}</a>   
                                            <div>
                                                {% if rep_comment.rep_mess_image %}
                                                    <h1><img src="{{ rep_comment.rep_mess_image.url }}" width="100" height="100"></h1>
                                                {% endif %}
                                            </div>                           
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div> 
                        </div>
                        <br>
                        {% endfor %}
                    </div>      
                </div>
            </div>
        {% endfor %}
    </div>
    
    <div>
        <h3 style="text-align: center;">Đang hoạt động</h3>
        <hr>
    </div>

</div>

<script 
    src="https://code.jquery.com/jquery-3.5.1.js" 
    integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" 
    crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>


<script>
var scrollPosition = localStorage.getItem("scrollPosition");
if (scrollPosition) {
    $(window).scrollTop(scrollPosition);
    localStorage.removeItem("scrollPosition");
}

$(document).on('submit', '#like-form', function(e) {
    e.preventDefault();
    var form = $(this);
    var likeId = form.data('like-id');
    var isLiked = form.data('liked');
    var count_comment =form.data('comment')

    $.ajax({
    type: 'POST',
    url: '/post_likes_homepage/' + likeId + '/',
    data: {
        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
    },
    success: function(data) {
        var Liked_button = $('#like-button-'+ likeId);
        var Liked_count =  $('#like-count-' + likeId);
        var Liked_user =   $('#list_like-'  + likeId);
        var thongdiep =  $('#thongdiep-'  + likeId);

        if (data.liked) {
            Liked_button.text('Like').css('color', 'blue').css('font-weight', 'bold');
            form.data('liked',true);
            if (data.likes_count > 0) {
                Liked_count.text(data.likes_count + ' like' + (data.likes_count > 1 ? 's' : ''));
                } else {
                    Liked_count.text(''); 
                }
        }
        else {
            Liked_button.text('Like').css('color', 'black').css('font-weight', 'bold');
            form.data('liked',false);
            if (data.likes_count > 0) {
                Liked_count.text(data.likes_count + ' like' + (data.likes_count > 1 ? 's' : ''));
                } else {
                    Liked_count.text(''); 
                }
        };
        Liked_user.empty();
            for (var i = 0; i < data.all_user_like.length; i++) {
                Liked_user.append(data.all_user_like[i]);};
    }
    });
});



$(document).on('submit', '#like-popup-form', function(e) {
    e.preventDefault();
    var form = $(this);
    var likeId_1 = form.data('like-id-section');
    var section_data = form.data('liked-section')
    var popup = document.getElementById("comment-popup-" + likeId_1);
    var popupScrollPosition = $(popup).scrollTop();

    $.ajax({
        type: 'POST',
        url: '/post_like_post_comment_section/' + likeId_1 + '/',
        data: {
            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
        },
        success: function(data) {
            var liked_button_section = $('#like-button-section-' + likeId_1);
            var liked_count_section = $('#like-count-section-' + likeId_1);

            if (data.liked_section) {
            liked_button_section.text('Like').css('color', 'blue');
            form.data('liked-section',true);
            if (data.likes_count_section > 0) {
                liked_count_section.text(data.likes_count_section + ' like' + (data.likes_count_section > 1 ? 's' : ''));
                } else {
                    liked_count_section.text(''); 
                }   
        }
        else {
            liked_button_section.text('Like').css('color', 'black');
            form.data('liked-section',false);
            if (data.likes_count_section > 0) {
                liked_count_section.text(data.likes_count_section + ' like' + (data.likes_count_section > 1 ? 's' : ''));
                } else {
                    liked_count_section.text(''); 
                }
           
        };         
        }
    });
});

var currentPostID = null;
function toggleCommentPopupWithDelay(postID) {
    if (currentPostID !== postID) {
        closeCommentPopup();
        currentPostID = postID;
        setTimeout(function() {
            var popup = document.getElementById("comment-popup-" + postID);
            popup.style.display = "block";
        }, 300);
    } else {
        closeCommentPopup();
        currentPostID = null;
    }
}
function closeCommentPopup() {
    if (currentPostID !== null) {
        var popup = document.getElementById("comment-popup-" + currentPostID);
        popup.style.display = "none";
        currentPostID = null;
    }
}
function closePopupAndReload() {
    closeCommentPopup();
    var scrollPosition = $(window).scrollTop();
    localStorage.setItem("scrollPosition", scrollPosition);
    setTimeout(function() {
        location.reload();
    }, 10);
}

$(document).on('submit', '#send-comment', function(e) {
    e.preventDefault();
    var form = $(this);
    var sendcommentId = form.data('send-id');
    var popup_q = document.getElementById("comment-popup-" + sendcommentId);
    var popupScrollPosition_cmt = $(popup_q).scrollTop();
    var message = form.find('textarea[name="message"]').val();
    var massageImage = $("#massage_image").prop('files')[0];
    var formData = new FormData();
    formData.append('message', message);
    formData.append('massage_image', massageImage);
    formData.append('csrfmiddlewaretoken', $('input[name=csrfmiddlewaretoken]').val());
    $.ajax({
        type: 'POST',
        url: '/send_comment/' + sendcommentId + '/',
        data: formData,
        processData: false,
        contentType: false,
        success: function() {  
            localStorage.setItem("popupScrollPosition_cmt", popupScrollPosition_cmt); 
            localStorage.setItem("sendcommentId", sendcommentId);
            setTimeout(function() {
                location.reload();
            }, 50);
        }
    });
});

$(document).ready(function() {
    var popupScrollPosition_cmt = localStorage.getItem("popupScrollPosition_cmt"); 
    var sendcommentId = localStorage.getItem("sendcommentId"); 
    
    if (popupScrollPosition_cmt && sendcommentId) {
        var popup = document.getElementById("comment-popup-" + sendcommentId);
        popup.style.display = "block";
        popup.scrollTop = popupScrollPosition_cmt; 
        localStorage.removeItem("popupScrollPosition_cmt"); 
        localStorage.removeItem("sendcommentId"); 
    }
});

function commentAndRefresh(postID) {
    var scrollPosition = $(window).scrollTop();
    localStorage.setItem("scrollPosition", scrollPosition);
    setTimeout(function() {
        location.reload();
    }, 10);
    sessionStorage.setItem("currentPostID", postID);
            }
    window.onload = function() {
        var currentPostID = sessionStorage.getItem("currentPostID");
        if (currentPostID) {
            sessionStorage.removeItem("currentPostID");
            setTimeout(function() {
                var popup = document.getElementById("comment-popup-" + currentPostID);
                if (popup) {
                    popup.style.display = "block";
                }
            },100);
        }
};

function searchUser() {
    var query = document.getElementById("searchInput").value;
    var searchResultsDiv = document.getElementById("searchResults");
    if (!query) {
        searchResultsDiv.innerHTML = "";
        return;
    }
    $.ajax({
        type: 'GET',
        url: '/search_user/',
        data: { query: query },
        success: function(data) {
            var URL = $("#searchResults a").data("url");
            var resultsHTML = ""; 
            resultsHTML += "<br><li>Kết quả tìm kiếm: </li><br>"
            for (var i = 0; i < data.length; i++) {
                
                resultsHTML += '<a class="testjs" href="' + data[i].profile_url + '">' + data[i].username + '</a><br>';
            }
            searchResultsDiv.innerHTML = resultsHTML; 
        },
        error: function() {
            searchResultsDiv.innerHTML = "<p>Đã xảy ra lỗi khi tìm kiếm</p>";
        }
    });
}

function sharePost(postId) {
    var popupCard = document.getElementById('share-card-' + postId);
    popupCard.style.display = 'block';
}

document.addEventListener('click', function(event) {
    var targetElement = event.target;
    if (targetElement.tagName === 'BUTTON' && targetElement.id.startsWith('share-button-')) {
        var postId = targetElement.id.slice('share-button-'.length);
        sharePost(postId);
    } else {
        var allPopups = document.querySelectorAll('.card-sharepost_popup');
        allPopups.forEach(function(popup) {
            if (popup.style.display === 'block' && !popup.contains(targetElement)) {
                popup.style.display = 'none';
            }
        });
    }
});


$(document).on('submit', '#share-form', function(e) {
    e.preventDefault();
    var form = $(this);
    var shareId = form.data('share-id');
    var discription_sh = form.find('textarea[name="discription_sh"]').val();
    var formData = new FormData();
    formData.append('discription_sh', discription_sh);
    formData.append('csrfmiddlewaretoken', $('input[name=csrfmiddlewaretoken]').val());
    toastr.options.timeOut = 4000;
    $.ajax({
        type: 'POST',
        url: '/share_post_views/' + shareId + '/',
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {  
            var scrollPosition = $(window).scrollTop();
            localStorage.setItem("scrollPosition", scrollPosition);
            if (data.boolean){
                toastr.success('Đã chia sẻ bài viết lên trang cá nhân của bạn!', 'Thông báo');
                setTimeout(function() {location.reload(); }, 2000);} 
            else {
                toastr.success('Bạn đã chia sẽ bài viết này 1 lần rồi', 'Thông báo');
                setTimeout(function() {location.reload(); }, 2000);
            }     
        }
    });
});

</script> 

{% endblock %}




